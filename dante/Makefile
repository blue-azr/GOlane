# Makefile for RTD1619B Dante Network System

GO = go
CC = gcc

# Dante SDK è·¯å¾‘ (ç•¶å‰ç›®éŒ„)
DANTE_BASE = .

# Dante API ç·¨è­¯åƒæ•¸
DAPI_INC = -I$(DANTE_BASE)/include/audinate -I$(DANTE_BASE)/include
DAPI_LIBS = $(DANTE_BASE)/lib/libdapi.a $(DANTE_BASE)/lib/libcurl.a $(DANTE_BASE)/lib/libjansson.a $(DANTE_BASE)/lib/libssl.a $(DANTE_BASE)/lib/libcrypto.a $(DANTE_BASE)/lib/libz.a -L$(DANTE_BASE)/redist -ldns_sd -ldl -lpthread -lstdc++ -lm

DAPI_WARNS = -Wall -Wundef -Wcast-align -Wwrite-strings -Wmissing-prototypes -Wstrict-prototypes -Wmissing-declarations
DAPI_CFLAGS = -g -std=c99 $(DAPI_WARNS) -fPIC

# ç›®æ¨™æª”æ¡ˆ
TARGET_GO = danteCS
WRAPPER_LIB = libdante_wrapper.a
WRAPPER_SRC = dante_wrapper.c
GO_SRC = main.go

.PHONY: all clean wrapper run help

all: wrapper $(TARGET_GO)

# ç·¨è­¯ C wrapper éœæ…‹åº«
wrapper: $(WRAPPER_LIB)

$(WRAPPER_LIB): $(WRAPPER_SRC)
	@echo "ğŸ”¨ Building C wrapper library..."
	$(CC) $(DAPI_CFLAGS) $(DAPI_INC) -c -o dante_wrapper.o $(WRAPPER_SRC)
	ar rcs $@ dante_wrapper.o
	@echo "âœ… C wrapper library built: $(WRAPPER_LIB)"

# ç·¨è­¯ Go ç¨‹å¼ï¼ˆä½¿ç”¨ CGOï¼‰
$(TARGET_GO): $(GO_SRC) $(WRAPPER_LIB)
	@echo "ğŸ”¨ Building Go application with Dante SDK..."
	CGO_CFLAGS="$(DAPI_INC)" \
	CGO_LDFLAGS="-L. -ldante_wrapper $(DAPI_LIBS)" \
	$(GO) build -o $(TARGET_GO) $(GO_SRC)
	@echo "âœ… Go application built: $(TARGET_GO)"

# é‹è¡Œç¨‹å¼
run: $(TARGET_GO)
	@echo "ğŸš€ Starting RTD1619B Dante Network System..."
	./$(TARGET_GO)

# æ¸…ç†
clean:
	@echo "ğŸ§¹ Cleaning build files..."
	rm -f $(TARGET_GO) $(WRAPPER_LIB) *.o
	@echo "âœ… Clean completed"

# æª¢æŸ¥ç’°å¢ƒ
check-env:
	@echo "=== Environment Check ==="
	@echo "Current directory: $(shell pwd)"
	@echo "Dante SDK path: $(DANTE_BASE)"
	@test -d $(DANTE_BASE)/include && echo "âœ“ include directory found" || (echo "âœ— include directory not found" && exit 1)
	@test -d $(DANTE_BASE)/lib && echo "âœ“ lib directory found" || (echo "âœ— lib directory not found" && exit 1)
	@test -d $(DANTE_BASE)/redist && echo "âœ“ redist directory found" || (echo "âœ— redist directory not found" && exit 1)
	@test -f $(WRAPPER_SRC) && echo "âœ“ C wrapper source found" || (echo "âœ— C wrapper source not found" && exit 1)
	@test -f $(GO_SRC) && echo "âœ“ Go source found" || (echo "âœ— Go source not found" && exit 1)
	@echo "========================="

# å¹«åŠ©
help:
	@echo "Available targets:"
	@echo "  all       - Build C wrapper and Go application"
	@echo "  wrapper   - Build only C wrapper library"
	@echo "  run       - Build and run the application"
	@echo "  clean     - Remove build files"
	@echo "  check-env - Check build environment"
	@echo "  help      - Show this help"